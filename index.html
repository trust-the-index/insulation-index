<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>EE INDEX | Mapping Privilege</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/h3-js"></script>
    <style>
        :root { --manager-red: #ff4444; --community-green: #22c55e; --border: #222; }
        body, html { margin: 0; padding: 0; height: 100%; background: #000; color: #fff; font-family: 'Inter', sans-serif; overflow: hidden; }
        
        /* Layout */
        #header { height: 70px; border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 25px; background: #000; z-index: 2000; position: relative; }
        #map { position: absolute; top: 70px; bottom: 0; width: 100%; z-index: 1; background: #050505; }
        #sidebar { position: absolute; top: 70px; left: 0; bottom: 0; width: 320px; background: rgba(0,0,0,0.95); z-index: 1500; border-right: 1px solid var(--border); padding: 25px; box-sizing: border-box; display: flex; flex-direction: column; }

        /* UI Elements */
        .pq-logo { color: var(--manager-red); font-weight: bold; border: 1px solid var(--manager-red); padding: 5px 12px; text-decoration: none; font-size: 13px; letter-spacing: 2px; margin-right: 30px; }
        #addrSearch { flex-grow: 1; max-width: 450px; padding: 12px 20px; border: 1px solid #333; background: #0a0a0a; color: var(--manager-red); outline: none; border-radius: 4px; font-family: monospace; font-size: 13px; }
        
        .section-label { font-size: 10px; color: #555; letter-spacing: 2px; margin-bottom: 20px; display: block; text-transform: uppercase; border-bottom: 1px solid #222; padding-bottom: 5px; }
        .row { display: flex; justify-content: space-between; margin-bottom: 15px; font-size: 12px; color: #aaa; }
        .toggle { color: var(--manager-red); cursor: pointer; text-decoration: underline; font-weight: bold; }
        .toggle.off { color: #333; text-decoration: none; }

        /* Score Panel */
        .index-panel { position: absolute; bottom: 40px; right: 40px; z-index: 1000; background: #000; border: 1px solid #333; padding: 25px; width: 260px; text-align: center; }
        .score-val { font-size: 64px; font-weight: 900; line-height: 1; margin: 10px 0; letter-spacing: -2px; }
        .status-msg { font-size: 11px; font-weight: bold; letter-spacing: 1px; text-transform: uppercase; min-height: 30px; }

        /* Buttons & Modals */
        .btn-ui { background: #111; border: 1px solid #333; color: #888; padding: 10px; margin-top: 10px; cursor: pointer; font-size: 11px; text-transform: uppercase; letter-spacing: 1px; }
        .btn-ui:hover { border-color: var(--manager-red); color: #fff; }
        .modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 400px; background: #000; border: 1px solid #333; padding: 30px; z-index: 3000; box-shadow: 0 0 50px rgba(0,0,0,1); }
        .modal h2 { font-size: 14px; color: var(--manager-red); letter-spacing: 2px; margin-top: 0; }
        .modal-close { color: #555; cursor: pointer; float: right; }
    </style>
</head>
<body>

    <div id="header">
        <a href="#" class="pq-logo">EE_INDEX</a>
        <input type="text" id="addrSearch" placeholder="LOCATING ENCLAVES..." onkeydown="if(event.key==='Enter') doSearch()">
    </div>

    <div id="sidebar">
        <span class="section-label">Disruption Filters</span>
        <div class="row">GOLF COURSES <span class="toggle" onclick="flip(this)">ON</span></div>
        <div class="row">WHOLE FOODS <span class="toggle" onclick="flip(this)">ON</span></div>
        <div class="row">PRIVATE EQUITY HQ <span class="toggle" onclick="flip(this)">ON</span></div>
        <div class="row">YACHT CLUBS <span class="toggle" onclick="flip(this)">ON</span></div>
        <div class="row">KAREN DENSITY <span class="toggle" onclick="flip(this)">ON</span></div>

        <div style="flex-grow: 1;"></div>

        <button class="btn-ui" onclick="toggleModal('modalBoard')">Echo Chamber Leaderboard</button>
        <button class="btn-ui" onclick="toggleModal('modalMethod')">Our Methodology</button>
        
        <div style="margin-top:20px; font-size:9px; color:#333; text-align:center;">
            SATIRE // MAPPING PRIVILEGE.
        </div>
    </div>

    <div id="map"></div>

    <div class="index-panel">
        <div id="statusText" class="status-msg">SCANNING...</div>
        <div id="pqVal" class="score-val">--</div>
        <div style="font-size:9px; color:#555; letter-spacing:1px;">ENTITLEMENT & EXCESS INDEX</div>
    </div>

    <div id="modalBoard" class="modal">
        <span class="modal-close" onclick="toggleModal('modalBoard')">✕</span>
        <h2>TOP 5 ECHO CHAMBERS</h2>
        <div class="row" style="color:#fff;">1. Atherton, CA <span style="color:var(--manager-red);">99.8</span></div>
        <div class="row" style="color:#fff;">2. Palm Beach, FL <span style="color:var(--manager-red);">99.2</span></div>
        <div class="row" style="color:#fff;">3. Greenwich, CT <span style="color:var(--manager-red);">98.9</span></div>
        <div class="row" style="color:#fff;">4. Beverly Hills, CA <span style="color:var(--manager-red);">97.5</span></div>
        <div class="row" style="color:#fff;">5. Scarsdale, NY <span style="color:var(--manager-red);">96.1</span></div>
    </div>

    <div id="modalMethod" class="modal">
        <span class="modal-close" onclick="toggleModal('modalMethod')">✕</span>
        <h2>METHODOLOGY</h2>
        <p style="font-size:11px; line-height:1.6; color:#888;">
            Our proprietary algorithm aggregates "Point of Exclusion" data into H3 hexagonal cells. 
            Unlike other maps that stigmatize poverty, we label concentrations of extreme wealth as "Hazardous Entitlement Zones." 
            <br><br>
            <strong>Penalty Weights:</strong><br>
            Country Club: -15 pts<br>
            Hedge Fund Hub: -20 pts<br>
            Private Jet FBO: -25 pts
        </p>
    </div>

    <script>
        const map = L.map('map', { zoomControl: false, minZoom: 4 }).setView([37.8, -96], 4);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

        const hexLayer = L.layerGroup().addTo(map);

        // Fixed Hazard Data
        const toxicHotspots = [
            {lat: 34.07, lng: -118.40, base: 98}, // Beverly Hills
            {lat: 41.03, lng: -73.62, base: 99}, // Greenwich
            {lat: 26.70, lng: -80.03, base: 97}, // Palm Beach
            {lat: 37.46, lng: -122.19, base: 99}, // Atherton
            {lat: 43.47, lng: -110.76, base: 92}, // Jackson Hole
            {lat: 33.53, lng: -111.94, base: 88}, // Paradise Valley
            {lat: 25.76, lng: -80.14, base: 99}   // Fisher Island
        ];

        function getStatus(s) {
            if (s > 80) return { t: "Let Me Speak to the Manager", c: "#ff4444" };
            if (s > 60) return { t: "NIMBY Stronghold", c: "#f97316" };
            if (s > 40) return { t: "Gentri-fied", c: "#fbbf24" };
            return { t: "Community Driven", c: "#22c55e" };
        }

        function refreshMap() {
            hexLayer.clearLayers();
            const zoom = map.getZoom();
            if (zoom < 6) return;

            const res = zoom > 10 ? 8 : 7;
            const center = map.getCenter();
            const cells = h3.gridDisk(h3.latLngToCell(center.lat, center.lng, res), res === 8 ? 8 : 4);

            cells.forEach(cell => {
                const latLng = h3.cellToLatLng(cell);
                const corners = h3.cellToBoundary(cell);
                
                let score = 15; // Safe base
                toxicHotspots.forEach(hs => {
                    const d = map.distance(latLng, [hs.lat, hs.lng]);
                    if (d < 25000) score += (hs.base - (d/250));
                });

                if (score > 100) score = 99.7;
                const status = getStatus(score);

                if (score > 30) {
                    L.polygon(corners, {
                        color: '#111', weight: 0.5, fillColor: status.c, fillOpacity: 0.4
                    }).addTo(hexLayer).on('mouseover', () => {
                        document.getElementById('pqVal').innerText = score.toFixed(1);
                        document.getElementById('pqVal').style.color = status.c;
                        document.getElementById('statusText').innerText = status.t;
                        document.getElementById('statusText').style.color = status.c;
                    });
                }
            });
        }

        function toggleModal(id) {
            const m = document.getElementById(id);
            m.style.display = (m.style.display === 'block') ? 'none' : 'block';
        }

        function flip(el) { el.classList.toggle("off"); refreshMap(); }

        function doSearch() {
            const val = document.getElementById('addrSearch').value;
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${val}&countrycodes=us`)
                .then(r => r.json()).then(d => { if(d[0]) map.setView([d[0].lat, d[0].lon], 13); });
        }

        map.on('moveend', refreshMap);
        refreshMap();
    </script>
</body>
</html>

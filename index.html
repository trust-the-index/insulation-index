<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>PQ // The Hazard Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/h3-js"></script>
    <style>
        :root { --hazard-red: #ef4444; --safe-blue: #3b82f6; --elite-toxic: #4ade80; }
        body, html { margin: 0; padding: 0; height: 100%; background: #000; color: white; font-family: 'Courier New', monospace; overflow: hidden; }
        
        #header { height: 60px; border-bottom: 1px solid #333; display: flex; align-items: center; padding: 0 20px; background: #000; z-index: 2000; position: relative; }
        #map { position: absolute; top: 60px; bottom: 0; width: 100%; z-index: 1; background: #050505; }
        #sidebar { position: absolute; top: 60px; left: 0; bottom: 0; width: 300px; background: rgba(0,0,0,0.9); z-index: 1500; border-right: 1px solid #333; padding: 20px; }

        .pq-logo { color: var(--hazard-red); font-weight: bold; border: 1px solid var(--hazard-red); padding: 5px 10px; margin-right: 20px; text-decoration: none; }
        #addrSearch { flex-grow: 1; max-width: 400px; padding: 8px 15px; border: 1px solid #333; background: #111; color: var(--hazard-red); outline: none; }
        
        .row { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 11px; color: #888; }
        .toggle { color: var(--hazard-red); cursor: pointer; font-weight: bold; }
        .toggle.off { color: #333; }
        
        .index-panel { position: absolute; bottom: 25px; right: 25px; z-index: 1000; background: #000; border: 1px solid var(--hazard-red); padding: 15px; width: 220px; text-align: center; }
        .warning-text { font-size: 10px; color: var(--hazard-red); letter-spacing: 2px; animation: blink 1s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
    </style>
</head>
<body>

    <div id="header">
        <a href="#" class="pq-logo">HAZARD // ELITE_SCAN</a>
        <input type="text" id="addrSearch" placeholder="SCANNING FOR TOXIC WEALTH..." onkeydown="if(event.key==='Enter') doSearch()">
    </div>

    <div id="sidebar">
        <div style="font-size:10px; color:var(--hazard-red); margin-bottom:20px;">[ TOXICITY INDICATORS ]</div>
        <div class="row">GOLF COURSE PROXIMITY <span class="toggle" onclick="flip(this)">ON</span></div>
        <div class="row">WHOLE FOODS SATURATION <span class="toggle" onclick="flip(this)">ON</span></div>
        <div class="row">GATED LATENCY <span class="toggle" onclick="flip(this)">ON</span></div>
        <div class="row">EQUESTRIAN OVERLAY <span class="toggle" onclick="flip(this)">ON</span></div>
        <div class="row">ZERO SIDEWALK ZONES <span class="toggle" onclick="flip(this)">ON</span></div>
        
        <hr style="border:0; border-top:1px solid #222; margin:20px 0;">
        <div style="font-size:10px; color:#444;">NOTE: High PQ Index (80+) indicates a "Dead Zone" or high-exclusion enclave. Avoid for normal social interaction.</div>
    </div>

    <div id="map"></div>

    <div class="index-panel">
        <div class="warning-text">!! HAZARD DETECTED !!</div>
        <div style="font-size:10px; color:#666; margin: 5px 0;">INSULATION SCORE</div>
        <div id="pqVal" style="font-size:40px; font-weight:bold; color:var(--hazard-red);">--</div>
    </div>

    <script>
        const map = L.map('map', { zoomControl: false }).setView([37.8, -96], 4);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

        const hexLayer = L.layerGroup().addTo(map);

        // We use a persistent seed for "Wealth Hazard" locations
        const toxicHotspots = [
            [34.07, -118.40], [41.03, -73.62], [26.70, -80.03], [37.46, -122.19],
            [40.99, -73.79], [25.76, -80.14], [47.62, -122.23], [42.10, -87.73]
        ];

        function renderHazards() {
            hexLayer.clearLayers();
            const zoom = map.getZoom();
            if (zoom < 5) return;

            const bounds = map.getBounds();
            const res = zoom > 10 ? 8 : 7;
            
            // Get hexes in the current view
            const center = map.getCenter();
            const hexes = h3.gridDisk(h3.latLngToCell(center.lat, center.lng, res), res === 8 ? 8 : 5);

            hexes.forEach(hex => {
                const coords = h3.cellToLatLng(hex);
                const corners = h3.cellToBoundary(hex);
                
                // Calculate "Toxicity" based on proximity to rich spots or random affluent noise
                let distToElite = 100;
                toxicHotspots.forEach(spot => {
                    const d = map.distance(coords, spot);
                    if (d < distToElite) distToElite = d;
                });

                // Scoring: Rich = 100 (Bad), Poor = 0 (Good/Normal)
                let score = Math.floor(Math.random() * 40); // Baseline "Normal" score
                
                // If it's a known rich area or matches our filters, spike the score
                if (Math.abs(coords[0] - 34) < 0.5) score += 50; // Beverly Hills area hazard
                
                const color = score > 70 ? '#4ade80' : score > 40 ? '#422006' : 'transparent';
                
                if (color !== 'transparent') {
                    L.polygon(corners, {
                        color: '#222', weight: 1, fillColor: color, fillOpacity: 0.6
                    }).addTo(hexLayer).on('mouseover', () => {
                        document.getElementById('pqVal').innerText = score;
                        document.getElementById('pqVal').style.color = (score > 70) ? '#4ade80' : '#888';
                    });
                }
            });
        }

        function flip(el) {
            el.classList.toggle("off");
            renderHazards();
        }

        function doSearch() {
            const val = document.getElementById('addrSearch').value;
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${val}&countrycodes=us`)
                .then(r => r.json()).then(data => {
                    if (data.length > 0) map.setView([data[0].lat, data[0].lon], 13);
                });
        }

        map.on('moveend', renderHazards);
        renderHazards();
    </script>
</body>
</html>

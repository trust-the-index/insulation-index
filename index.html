<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EE Index | Mapping Privilege</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/h3-js"></script>
    <style>
        :root { --manager-red: #ff4d4d; --safe-green: #00e676; --nimby-orange: #ff9100; --white: #ffffff; --bg-gray: #f8f9fa; }
        body, html { margin: 0; padding: 0; height: 100%; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg-gray); overflow: hidden; }
        
        /* Floating Search Bar */
        #search-container { position: absolute; top: 20px; left: 20px; right: 20px; z-index: 2000; display: flex; gap: 10px; pointer-events: none; }
        .logo-box { pointer-events: auto; background: var(--white); padding: 10px 18px; border-radius: 12px; font-weight: 800; color: var(--manager-red); box-shadow: 0 4px 12px rgba(0,0,0,0.08); border: 1px solid #eee; display: flex; align-items: center; text-decoration: none; font-size: 14px; letter-spacing: 1px; }
        .search-input-wrapper { pointer-events: auto; background: var(--white); border-radius: 12px; padding: 10px 20px; flex-grow: 1; max-width: 500px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); border: 1px solid #eee; display: flex; align-items: center; }
        #addrSearch { border: none; outline: none; width: 100%; font-size: 15px; color: #333; }

        /* The Map */
        #map { position: absolute; top: 0; bottom: 0; width: 100%; z-index: 1; background: #e5e3df; }

        /* Sidebar - Exact Clone Style */
        #sidebar { position: absolute; top: 90px; left: 20px; bottom: 30px; width: 340px; background: var(--white); z-index: 1500; border-radius: 16px; padding: 24px; box-shadow: 0 8px 24px rgba(0,0,0,0.12); border: 1px solid #eee; overflow-y: auto; display: flex; flex-direction: column; }
        .tab-nav { display: flex; gap: 20px; border-bottom: 1px solid #f0f0f0; margin-bottom: 20px; padding-bottom: 10px; font-size: 13px; font-weight: 600; color: #999; }
        .tab-nav span.active { color: #000; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: -12px; }
        
        .filter-header { font-size: 18px; font-weight: 700; color: #111; margin-bottom: 15px; }
        .name-search-bar { background: #f1f3f5; border-radius: 8px; border: none; padding: 10px; width: 100%; box-sizing: border-box; margin-bottom: 20px; font-size: 13px; }
        
        .row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #f8f9fa; font-size: 14px; color: #444; }
        .toggle-switch { width: 34px; height: 18px; background: #ddd; border-radius: 20px; position: relative; cursor: pointer; transition: 0.3s; }
        .toggle-switch.on { background: var(--manager-red); }
        .toggle-circle { width: 14px; height: 14px; background: white; border-radius: 50%; position: absolute; top: 2px; left: 2px; transition: 0.3s; }
        .toggle-switch.on .toggle-circle { left: 18px; }

        /* Score Panel (The Manager HUD) */
        .score-panel { position: absolute; bottom: 30px; right: 20px; z-index: 1000; background: var(--white); padding: 20px; border-radius: 16px; width: 220px; box-shadow: 0 8px 24px rgba(0,0,0,0.15); border: 1px solid #eee; text-align: center; }
        .score-label { font-size: 10px; font-weight: 700; color: #999; letter-spacing: 1px; margin-bottom: 5px; }
        .score-value { font-size: 48px; font-weight: 800; color: #333; margin: 5px 0; letter-spacing: -1px; }
        .score-status { font-size: 11px; font-weight: 700; color: #666; text-transform: uppercase; }

        /* Heatmap Glow Animation */
        @keyframes pulse-glow {
            0% { fill-opacity: 0.35; stroke-width: 0.5; }
            50% { fill-opacity: 0.6; stroke-width: 2; }
            100% { fill-opacity: 0.35; stroke-width: 0.5; }
        }
        .toxic-hex { animation: pulse-glow 2s infinite ease-in-out; }
    </style>
</head>
<body>

    <div id="search-container">
        <a href="#" class="logo-box">EE INDEX</a>
        <div class="search-input-wrapper">
            <input type="text" id="addrSearch" placeholder="Search a neighborhood..." onkeydown="if(event.key==='Enter') doSearch()">
        </div>
    </div>

    <div id="sidebar">
        <div class="tab-nav">
            <span class="active">Stats</span>
            <span onclick="window.location.href='methodology.html'" style="cursor:pointer">Methodology</span>
            <span style="cursor:not-allowed">Leaderboard</span>
        </div>

        <div class="filter-header">Indicators</div>
        <input type="text" class="name-search-bar" placeholder="Filter by name (e.g. Karen, Chad, Hunter)">

        <div class="row">KAREN DENSITY <div class="toggle-switch on" onclick="toggle(this)"> <div class="toggle-circle"></div> </div></div>
        <div class="row">HEDGE FUNDS <div class="toggle-switch on" onclick="toggle(this)"> <div class="toggle-circle"></div> </div></div>
        <div class="row">YACHT CLUBS <div class="toggle-switch on" onclick="toggle(this)"> <div class="toggle-circle"></div> </div></div>
        <div class="row">GATED ENTRANCES <div class="toggle-switch on" onclick="toggle(this)"> <div class="toggle-circle"></div> </div></div>
        <div class="row">GOLF COURSES <div class="toggle-switch on" onclick="toggle(this)"> <div class="toggle-circle"></div> </div></div>
        
        <div style="margin-top:auto; padding-top:20px;">
            <button style="width:100%; background:#000; color:#fff; border:none; padding:12px; border-radius:8px; font-weight:600; cursor:pointer;">Request a Name</button>
        </div>
    </div>

    <div id="map"></div>

    <div class="score-panel">
        <div class="score-label">ENTITLEMENT SCORE</div>
        <div id="scoreVal" class="score-value">--</div>
        <div id="statusLabel" class="score-status">READY TO SCAN</div>
    </div>

    <script>
        const map = L.map('map', { zoomControl: false }).setView([37.8, -96], 4);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);

        const hexLayer = L.layerGroup().addTo(map);

        const eliteSpots = [
            {lat: 34.07, lng: -118.40, base: 98}, {lat: 41.03, lng: -73.62, base: 99}, 
            {lat: 26.70, lng: -80.03, base: 97}, {lat: 37.46, lng: -122.19, base: 99}, 
            {lat: 43.47, lng: -110.76, base: 92}, {lat: 40.75, lng: -73.98, base: 85}
        ];

        function getEEStatus(score) {
            if (score > 80) return { t: "Let Me Speak to the Manager", c: "#ff4d4d" };
            if (score > 60) return { t: "NIMBY Stronghold", c: "#ff9100" };
            if (score > 40) return { t: "Gentri-fied", c: "#ffc107" };
            if (score > 20) return { t: "Touch Grass", c: "#00b0ff" };
            return { t: "Community Driven", c: "#00e676" };
        }

        function refreshGrid() {
            hexLayer.clearLayers();
            const zoom = map.getZoom();
            if (zoom < 6) return;
            const res = zoom > 10 ? 8 : 7;
            const center = map.getCenter();
            const cells = h3.gridDisk(h3.latLngToCell(center.lat, center.lng, res), res === 8 ? 10 : 6);

            cells.forEach(cell => {
                const latLng = h3.cellToLatLng(cell);
                const corners = h3.cellToBoundary(cell);
                let score = 12 + (Math.random() * 5);
                eliteSpots.forEach(hs => {
                    const d = map.distance(latLng, [hs.lat, hs.lng]);
                    if (d < 20000) score += (hs.base - (d/200));
                });
                if (score > 100) score = 99.8;
                const status = getEEStatus(score);

                const poly = L.polygon(corners, {
                    color: score > 80 ? status.c : 'rgba(0,0,0,0.05)',
                    weight: 0.5,
                    fillColor: status.c,
                    fillOpacity: 0.35,
                    className: score > 80 ? 'toxic-hex' : ''
                }).addTo(hexLayer);

                poly.on('mouseover', () => {
                    document.getElementById('scoreVal').innerText = score.toFixed(1);
                    document.getElementById('scoreVal').style.color = status.c;
                    document.getElementById('statusLabel').innerText = status.t;
                    document.getElementById('statusLabel').style.color = status.c;
                });
            });
        }

        function toggle(el) { el.classList.toggle("on"); refreshGrid(); }
        function doSearch() {
            const val = document.getElementById('addrSearch').value;
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${val}&countrycodes=us`)
                .then(r => r.json()).then(data => { if (data[0]) map.setView([data[0].lat, data[0].lon], 13); });
        }
        map.on('moveend', refreshGrid);
        refreshGrid();
    </script>
</body>
</html>

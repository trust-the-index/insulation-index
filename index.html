<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>PQ // Elite Radar (USA)</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/h3-js"></script>
    <style>
        :root { --elite-green: #4ade80; --gold: #fbbf24; }
        body, html { margin: 0; padding: 0; height: 100%; background: #000; color: white; font-family: monospace; overflow: hidden; }
        
        #header { height: 65px; border-bottom: 1px solid #222; display: flex; align-items: center; padding: 0 20px; background: #000; z-index: 2000; position: relative; }
        #map { position: absolute; top: 65px; bottom: 0; width: 100%; z-index: 1; background: #050505; }
        #sidebar { position: absolute; top: 65px; left: 0; bottom: 0; width: 300px; background: rgba(0,0,0,0.9); z-index: 1500; border-right: 1px solid #222; padding: 20px; box-sizing: border-box; }

        .pq-logo { color: var(--elite-green); font-weight: bold; border: 1px solid var(--elite-green); padding: 5px 10px; margin-right: 20px; text-decoration: none; }
        #addrSearch { flex-grow: 1; max-width: 450px; padding: 10px 15px; border: 1px solid #333; background: #111; color: var(--elite-green); outline: none; border-radius: 4px; }
        
        .row { display: flex; justify-content: space-between; margin-bottom: 15px; font-size: 11px; color: #666; }
        .toggle { color: var(--elite-green); cursor: pointer; text-decoration: underline; }
        .toggle.off { color: #444; text-decoration: none; }
        
        .index-panel { position: absolute; bottom: 30px; right: 30px; z-index: 1000; background: #000; border: 1px solid var(--elite-green); padding: 20px; width: 220px; text-align: center; }
        .score-display { font-size: 44px; font-weight: bold; color: var(--elite-green); margin: 10px 0; }
        .method-note { font-size: 9px; color: #444; border-top: 1px solid #222; padding-top: 10px; line-height: 1.4; margin-top: 15px; }
    </style>
</head>
<body>

    <div id="header">
        <a href="#" class="pq-logo">PQ // USA_ELITE</a>
        <input type="text" id="addrSearch" placeholder="SEARCH USA COORDINATES... (e.g. Atherton, CA)" onkeydown="if(event.key==='Enter') doSearch()">
    </div>

    <div id="sidebar">
        <div style="font-size:10px; color:var(--elite-green); margin-bottom:20px; letter-spacing: 2px;">[ POSITIVE INDICATORS ]</div>
        <div class="row">WHOLE FOODS / EREWHON <span class="toggle" id="t_wf" onclick="flip(this)">ON</span></div>
        <div class="row">GOLF / COUNTRY CLUBS <span class="toggle" id="t_golf" onclick="flip(this)">ON</span></div>
        <div class="row">GATED COMMUNITY ENTRANCE <span class="toggle" id="t_gate" onclick="flip(this)">ON</span></div>
        <div class="row">EQUESTRIAN FACILITIES <span class="toggle" id="t_horse" onclick="flip(this)">ON</span></div>
        <div class="row">NO SIDEWALKS <span class="toggle" id="t_walk" onclick="flip(this)">ON</span></div>

        <div class="method-note">
            <strong>METHODOLOGY:</strong> The PQ Elite Index uses H3 Resolution 7-8 grids to aggregate proximity to private recreation, premium retail, and high-barrier residential zoning.
        </div>
    </div>

    <div id="map"></div>

    <div class="index-panel">
        <div style="font-size:10px; color:#666;">LOCAL PQ SCORE</div>
        <div id="pqVal" class="score-display">--</div>
        <div style="font-size:9px; color:#333;">NORMALIZED TO US 99th PERCENTILE</div>
    </div>

    <script>
        const usaBounds = L.latLngBounds([24.39, -125.0], [49.38, -66.93]);
        const map = L.map('map', { 
            zoomControl: false, 
            maxBounds: usaBounds, 
            minZoom: 4 
        }).setView([37.8, -96], 4);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
        const hexLayer = L.layerGroup().addTo(map);

        function updateRadar() {
            hexLayer.clearLayers();
            const zoom = map.getZoom();
            if (zoom < 6) return; // Only show grid when zoomed in

            const res = zoom > 10 ? 8 : 7;
            const center = map.getCenter();
            
            // Get local H3 grid based on map viewport
            const hexes = h3.gridDisk(h3.latLngToCell(center.lat, center.lng, res), res === 8 ? 6 : 4);

            hexes.forEach(hex => {
                const corners = h3.cellToBoundary(hex);
                const activeFilters = document.querySelectorAll('.toggle:not(.off)').length;
                
                // SATIRE CALCULATION
                // This simulates the "weighted aggregation" from the methodology
                let score = 30 + (activeFilters * 12) + (Math.random() * 10);
                if (score > 100) score = 99.7;

                // Color mapping: Elite Green for high PQ, dark for low
                const color = score > 80 ? '#4ade80' : score > 55 ? '#1a4a2e' : 'transparent';
                
                L.polygon(corners, {
                    color: '#222', weight: 1, fillColor: color, fillOpacity: 0.5
                }).addTo(hexLayer).on('mouseover', () => {
                    document.getElementById('pqVal').innerText = score.toFixed(1);
                    document.getElementById('pqVal').style.color = color;
                });
            });
        }

        function flip(el) {
            el.innerText = (el.innerText === "ON") ? "OFF" : "ON";
            el.classList.toggle("off");
            updateRadar();
        }

        function doSearch() {
            const val = document.getElementById('addrSearch').value;
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${val}&countrycodes=us`)
                .then(r => r.json()).then(data => {
                    if (data.length > 0) {
                        map.setView([data[0].lat, data[0].lon], 13);
                    }
                });
        }

        map.on('moveend', updateRadar);
        map.on('zoomend', updateRadar);
        updateRadar();
    </script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>EE INDEX | Mapping Privilege</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/h3-js"></script>
    <style>
        :root { --manager-red: #ff4444; --community-green: #22c55e; }
        body, html { margin: 0; padding: 0; height: 100%; background: #000; color: #fff; font-family: 'Inter', -apple-system, sans-serif; overflow: hidden; }
        
        /* The sterile, tech-bro UI of the original */
        #header { height: 70px; border-bottom: 1px solid #222; display: flex; align-items: center; padding: 0 25px; background: #000; z-index: 2000; position: relative; }
        #map { position: absolute; top: 70px; bottom: 0; width: 100%; z-index: 1; background: #050505; }
        #sidebar { position: absolute; top: 70px; left: 0; bottom: 0; width: 320px; background: rgba(0,0,0,0.98); z-index: 1500; border-right: 1px solid #222; padding: 25px; box-sizing: border-box; }

        .pq-logo { color: var(--manager-red); font-weight: bold; border: 1px solid var(--manager-red); padding: 5px 12px; text-decoration: none; font-size: 13px; letter-spacing: 2px; margin-right: 30px; }
        #addrSearch { flex-grow: 1; max-width: 450px; padding: 12px 20px; border: 1px solid #333; background: #0a0a0a; color: var(--manager-red); outline: none; border-radius: 4px; font-family: monospace; font-size: 13px; }
        
        .section-label { font-size: 10px; color: #555; letter-spacing: 2px; margin-bottom: 20px; display: block; border-bottom: 1px solid #222; padding-bottom: 5px; text-transform: uppercase; }
        .row { display: flex; justify-content: space-between; margin-bottom: 15px; font-size: 12px; color: #aaa; }
        .toggle { color: var(--manager-red); cursor: pointer; text-decoration: underline; font-weight: bold; }
        .toggle.off { color: #333; text-decoration: none; }

        /* The Fixed Score Panel */
        .index-panel { position: absolute; bottom: 40px; right: 40px; z-index: 1000; background: #000; border: 1px solid #333; padding: 25px; width: 260px; text-align: center; }
        .score-val { font-size: 64px; font-weight: 900; line-height: 1; margin: 10px 0; letter-spacing: -2px; }
        .status-msg { font-size: 11px; font-weight: bold; letter-spacing: 1px; text-transform: uppercase; min-height: 30px; }
    </style>
</head>
<body>

    <div id="header">
        <a href="#" class="pq-logo">EE_INDEX // SATIRE</a>
        <input type="text" id="addrSearch" placeholder="SCANNING FOR WEALTH HAZARDS..." onkeydown="if(event.key==='Enter') doSearch()">
    </div>

    <div id="sidebar">
        <span class="section-label">Disruption Filters</span>
        <div class="row">KAREN DENSITY <span class="toggle" onclick="flip(this)">ON</span></div>
        <div class="row">HEDGE FUNDS <span class="toggle" onclick="flip(this)">ON</span></div>
        <div class="row">COUNTRY CLUBS <span class="toggle" onclick="flip(this)">ON</span></div>
        <div class="row">PRIVATE JETS <span class="toggle" onclick="flip(this)">ON</span></div>
        <div class="row">ZERO SIDEWALKS <span class="toggle" onclick="flip(this)">ON</span></div>
        
        <div style="margin-top:40px; font-size:10px; color:#444; line-height:1.6;">
            <strong>METHODOLOGY:</strong><br>
            Our "EE Index" reverses the lens of exclusionary mapping. High scores represent areas of maximum resource hoarding and social insulation.
        </div>
    </div>

    <div id="map"></div>

    <div class="index-panel">
        <div id="statusText" class="status-msg">READY TO SCAN</div>
        <div id="pqVal" class="score-val">--</div>
        <div style="font-size:9px; color:#555; letter-spacing:1px;">ENTITLEMENT & EXCESS INDEX</div>
    </div>

    <script>
        // Initialize Map locked to USA
        const map = L.map('map', { zoomControl: false, minZoom: 4 }).setView([37.8, -96], 4);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

        const hexLayer = L.layerGroup().addTo(map);

        // Fixed "Hazard" Zones
        const hotspots = [
            {lat: 34.07, lng: -118.40, score: 98}, // Beverly Hills
            {lat: 41.03, lng: -73.62, score: 99}, // Greenwich
            {lat: 26.70, lng: -80.03, score: 97}, // Palm Beach
            {lat: 37.46, lng: -122.19, score: 99}, // Atherton
            {lat: 40.75, lng: -73.98, score: 85}, // Midtown (Hedge Funds)
            {lat: 43.47, lng: -110.76, score: 92}, // Jackson Hole
            {lat: 33.53, lng: -111.94, score: 88}  // Paradise Valley
        ];

        function getStatus(s) {
            if (s > 80) return { t: "Let Me Speak to the Manager", c: "#ff4444" };
            if (s > 60) return { t: "NIMBY Stronghold", c: "#f97316" };
            if (s > 40) return { t: "Gentri-fied", c: "#fbbf24" };
            return { t: "Community Driven", c: "#22c55e" };
        }

        function drawFixedGrid() {
            hexLayer.clearLayers();
            const zoom = map.getZoom();
            if (zoom < 6) return; // Don't clutter at high altitude

            const res = zoom > 10 ? 8 : 7;
            const bounds = map.getBounds();
            
            // This is the "magic" fix: it gets all hexes in the current VIEW
            // and anchors them to the map's coordinate system.
            const center = map.getCenter();
            const cells = h3.gridDisk(h3.latLngToCell(center.lat, center.lng, res), res === 8 ? 10 : 6);

            cells.forEach(cell => {
                const latLng = h3.cellToLatLng(cell);
                const corners = h3.cellToBoundary(cell);
                
                // Determine if this cell is near a hotspot
                let cellScore = 15; // Baseline Community Score
                hotspots.forEach(hs => {
                    const d = map.distance(latLng, [hs.lat, hs.lng]);
                    if (d < 20000) { // If within 20km of a rich spot
                        cellScore += (hs.score - (d/200));
                    }
                });

                if (cellScore > 100) cellScore = 99.8;
                const status = getStatus(cellScore);

                // Only draw if it's notable (keeps map clean like original)
                if (cellScore > 30) {
                    L.polygon(corners, {
                        color: '#111', weight: 0.5, fillColor: status.c, fillOpacity: 0.4
                    }).addTo(hexLayer).on('mouseover', () => {
                        document.getElementById('pqVal').innerText = cellScore.toFixed(1);
                        document.getElementById('pqVal').style.color = status.c;
                        document.getElementById('statusText').innerText = status.t;
                        document.getElementById('statusText').style.color = status.c;
                    });
                }
            });
        }

        function flip(el) {
            el.classList.toggle("off");
            drawFixedGrid();
        }

        function doSearch() {
            const val = document.getElementById('addrSearch').value;
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${val}&countrycodes=us`)
                .then(r => r.json()).then(data => {
                    if (data.length > 0) map.setView([data[0].lat, data[0].lon], 13);
                });
        }

        map.on('moveend', drawFixedGrid);
        drawFixedGrid();
    </script>
</body>
</html>

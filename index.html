<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>PQ // USA Elite Radar</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/h3-js"></script>
    <style>
        :root { --accent: #4ade80; --bg: #000; --panel: rgba(0,0,0,0.9); }
        body, html { margin: 0; padding: 0; height: 100%; background: var(--bg); color: white; font-family: 'Courier New', Courier, monospace; overflow: hidden; }
        
        /* Layout */
        #header { height: 75px; border-bottom: 1px solid #333; display: flex; align-items: center; padding: 0 25px; background: var(--bg); z-index: 2000; position: relative; }
        #map { position: absolute; top: 75px; bottom: 0; width: 100%; z-index: 1; background: #050505; }
        #sidebar { position: absolute; top: 75px; left: 0; bottom: 0; width: 320px; background: var(--panel); z-index: 1500; border-right: 1px solid #333; padding: 25px; box-sizing: border-box; }

        /* UI Elements */
        .pq-logo { color: var(--accent); font-weight: bold; border: 1.5px solid var(--accent); padding: 5px 12px; margin-right: 25px; text-decoration: none; font-size: 16px; letter-spacing: 2px; }
        #addrSearch { flex-grow: 1; max-width: 500px; padding: 12px 20px; border: 1px solid #444; background: #0a0a0a; color: var(--accent); outline: none; border-radius: 4px; font-family: inherit; }
        .row { display: flex; justify-content: space-between; margin-bottom: 18px; font-size: 12px; color: #888; }
        .toggle { color: var(--accent); cursor: pointer; text-decoration: underline; font-weight: bold; }
        .toggle.off { color: #555; text-decoration: none; }
        
        /* Stats Panel */
        .index-panel { position: absolute; bottom: 40px; right: 40px; z-index: 1000; background: var(--bg); border: 1px solid var(--accent); padding: 25px; width: 240px; box-shadow: 0 0 30px rgba(74, 222, 128, 0.15); }
        .methodology { font-size: 10px; color: #444; margin-top: 25px; border-top: 1px solid #222; padding-top: 15px; line-height: 1.5; }
    </style>
</head>
<body>

    <div id="header">
        <a href="#" class="pq-logo">PQ // USA_CORE</a>
        <input type="text" id="addrSearch" placeholder="SCANNING US COORDINATES... [ENTER ADDRESS]" onkeydown="if(event.key==='Enter') doSearch()">
    </div>

    <div id="sidebar">
        <div style="font-size:11px; color:var(--accent); margin-bottom:25px; letter-spacing: 2px;">[ STRESS INDICATORS ]</div>
        <div class="row">LIQUOR/FAST FOOD <span class="toggle" onclick="flip(this)">ON</span></div>
        <div class="row">PAYDAY LOANS/PAWN <span class="toggle" onclick="flip(this)">ON</span></div>
        <div class="row">SECTION 8/LIHTC <span class="toggle" onclick="flip(this)">ON</span></div>

        <hr style="border:0; border-top:1px solid #333; margin:25px 0;">
        
        <div style="font-size:11px; color:var(--accent); margin-bottom:20px; letter-spacing: 2px;">[ ELITE INDICATORS ]</div>
        <div class="row">RANGE ROVER DENSITY <span class="toggle" onclick="flip(this)">ON</span></div>
        <div class="row">PRIVATE SECURITY <span class="toggle" onclick="flip(this)">ON</span></div>
        <div class="row">ZERO SIDEWALKS <span class="toggle" onclick="flip(this)">ON</span></div>
        <div class="row">HEDGE HEIGHT > 8FT <span class="toggle" onclick="flip(this)">ON</span></div>

        <div class="methodology">
            <strong>METHODOLOGY:</strong> PQ Index aggregates POI data into H3 hexagonal grid cells (Res 7/8). Scores are normalized against the 99th percentile of US census tracts.
        </div>
    </div>

    <div id="map"></div>

    <div class="index-panel">
        <div style="font-size:11px; color:#666; margin-bottom:8px;">LOCALIZED PQ INDEX</div>
        <div id="pqVal" style="font-size:42px; font-weight:bold; color:var(--accent);">--</div>
        <div id="statusText" style="font-size:9px; color:#444; margin-top:10px; letter-spacing: 1px;">SYSTEM STANDBY</div>
    </div>

    <script>
        // USA Bounds & Initialization
        const usaBounds = L.latLngBounds([24.39, -125.0], [49.38, -66.93]);
        const map = L.map('map', { 
            zoomControl: false, 
            maxBounds: usaBounds, 
            minZoom: 4 
        }).setView([37.8, -96], 4);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

        const hexLayer = L.layerGroup().addTo(map);

        // Core H3 Rendering Logic
        function renderRadar() {
            hexLayer.clearLayers();
            const center = map.getCenter();
            const zoom = map.getZoom();
            
            // Auto-Resolution Logic
            const res = zoom > 10 ? 8 : 7;
            const mainHex = h3.latLngToCell(center.lat, center.lng, res - 1);
            const neighbors = h3.gridDisk(mainHex, res === 8 ? 3 : 2);

            neighbors.forEach(hex => {
                const corners = h3.cellToBoundary(hex);
                
                // Real-time Score Calculation
                const activeFilters = document.querySelectorAll('.toggle:not(.off)').length;
                let score = 50 + (activeFilters * 5) + (Math.random() * 10);
                if (score > 100) score = 99.8;

                const color = score > 85 ? '#4ade80' : score > 60 ? '#1a4a2e' : '#450a0a';
                
                L.polygon(corners, {
                    color: '#222', 
                    weight: 0.5, 
                    fillColor: color, 
                    fillOpacity: 0.45,
                    interactive: true
                }).addTo(hexLayer).on('mouseover', function() {
                    document.getElementById('pqVal').innerText = score.toFixed(1);
                    document.getElementById('pqVal').style.color = color;
                });
            });
        }

        function flip(el) {
            el.innerText = (el.innerText === "ON") ? "OFF" : "ON";
            el.classList.toggle("off");
            renderRadar();
        }

        function doSearch() {
            const val = document.getElementById('addrSearch').value;
            document.getElementById('statusText').innerText = "QUERYING H3 DATABASE...";
            
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${val}&countrycodes=us`)
                .then(r => r.json()).then(data => {
                    if (data.length > 0) {
                        map.setView([data[0].lat, data[0].lon], 13);
                        document.getElementById('statusText').innerText = "SCAN COMPLETE";
                    } else {
                        document.getElementById('statusText').innerText = "LOCATION NOT FOUND";
                    }
                });
        }

        map.on('moveend', renderRadar);
        renderRadar();
    </script>
</body>
</html>

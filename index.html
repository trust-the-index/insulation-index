<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>PQ // The EE Index</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/h3-js"></script>
    <style>
        :root { --manager-red: #ef4444; --community-green: #22c55e; --nimby-orange: #f97316; }
        body, html { margin: 0; padding: 0; height: 100%; background: #050505; color: white; font-family: 'Courier New', monospace; overflow: hidden; }
        
        #header { height: 65px; border-bottom: 1px solid #333; display: flex; align-items: center; padding: 0 20px; background: #000; z-index: 2000; position: relative; }
        #map { position: absolute; top: 65px; bottom: 0; width: 100%; z-index: 1; background: #000; }
        #sidebar { position: absolute; top: 65px; left: 0; bottom: 0; width: 320px; background: rgba(0,0,0,0.95); z-index: 1500; border-right: 1px solid #333; padding: 25px; box-sizing: border-box; }

        .pq-logo { color: var(--manager-red); font-weight: bold; border: 1.5px solid var(--manager-red); padding: 5px 12px; margin-right: 20px; text-decoration: none; font-size: 14px; letter-spacing: 1px; }
        #addrSearch { flex-grow: 1; max-width: 450px; padding: 10px 15px; border: 1px solid #444; background: #000; color: var(--manager-red); outline: none; border-radius: 4px; font-family: inherit; }
        
        .row { display: flex; justify-content: space-between; margin-bottom: 18px; font-size: 11px; color: #888; }
        .toggle { color: var(--manager-red); cursor: pointer; text-decoration: underline; font-weight: bold; }
        .toggle.off { color: #444; text-decoration: none; }
        
        .index-panel { position: absolute; bottom: 30px; right: 30px; z-index: 1000; background: #000; border: 2px solid var(--manager-red); padding: 20px; width: 250px; text-align: center; box-shadow: 0 0 20px rgba(239, 68, 68, 0.2); }
        .score-big { font-size: 48px; font-weight: bold; margin: 10px 0; }
        .status-label { font-size: 10px; font-weight: bold; letter-spacing: 2px; text-transform: uppercase; }
    </style>
</head>
<body>

    <div id="header">
        <a href="#" class="pq-logo">EE_INDEX // V.1.0</a>
        <input type="text" id="addrSearch" placeholder="LOCATE ENCLAVE BY ADDRESS..." onkeydown="if(event.key==='Enter') doSearch()">
    </div>

    <div id="sidebar">
        <div style="font-size:10px; color:var(--manager-red); margin-bottom:25px; letter-spacing: 2px;">[ EXCLUSION CRITERIA ]</div>
        <div class="row">KAREN/CHAD DENSITY (1.8w) <span class="toggle" onclick="flip(this)">ON</span></div>
        <div class="row">RESOURCE HOARDING (1.5w) <span class="toggle" onclick="flip(this)">ON</span></div>
        <div class="row">NIMBY SENTIMENT (1.2w) <span class="toggle" onclick="flip(this)">ON</span></div>
        <div class="row">"GATED" PSYCHOSIS (1.0w) <span class="toggle" onclick="flip(this)">ON</span></div>
        
        <hr style="border:0; border-top:1px solid #333; margin:25px 0;">
        <div style="font-size:10px; color:#555; line-height: 1.6;">
            <strong>THE EE SCALE:</strong><br>
            81-100: "MANAGER" ZONE (DANGER)<br>
            61-80: NIMBY STRONGHOLD<br>
            41-60: GENTRI-FIED<br>
            21-40: TOUCH GRASS<br>
            00-20: COMMUNITY DRIVEN (SAFE)
        </div>
    </div>

    <div id="map"></div>

    <div class="index-panel">
        <div id="statusLabel" class="status-label" style="color:var(--manager-red);">WAITING FOR SCAN</div>
        <div id="pqVal" class="score-big" style="color:var(--manager-red);">--</div>
        <div style="font-size:9px; color:#444;">NORMALIZED TO 99th PERCENTILE ENTITLEMENT</div>
    </div>

    <script>
        const usaBounds = L.latLngBounds([24.39, -125.0], [49.38, -66.93]);
        const map = L.map('map', { zoomControl: false, maxBounds: usaBounds, minZoom: 4 }).setView([37.8, -96], 4);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

        const hexLayer = L.layerGroup().addTo(map);

        function getStatus(score) {
            if (score > 80) return { t: "Let Me Speak to the Manager", c: "#ef4444" };
            if (score > 60) return { t: "NIMBY Stronghold", c: "#f97316" };
            if (score > 40) return { t: "Gentri-fied", c: "#fbbf24" };
            if (score > 20) return { t: "Touch Grass", c: "#3b82f6" };
            return { t: "Community Driven", c: "#22c55e" };
        }

        function updateGrid() {
            hexLayer.clearLayers();
            const zoom = map.getZoom();
            if (zoom < 6) return;

            const res = zoom > 10 ? 8 : 7;
            const center = map.getCenter();
            const hexes = h3.gridDisk(h3.latLngToCell(center.lat, center.lng, res), res === 8 ? 6 : 4);

            hexes.forEach(hex => {
                const corners = h3.cellToBoundary(hex);
                const activeFilters = document.querySelectorAll('.toggle:not(.off)').length;
                
                // Satirical "Entitlement" logic - higher score = more exclusionary
                let score = 10 + (activeFilters * 15) + (Math.random() * 20);
                if (score > 100) score = 99.1;

                const status = getStatus(score);
                
                L.polygon(corners, {
                    color: '#111', weight: 1, fillColor: status.c, fillOpacity: 0.4
                }).addTo(hexLayer).on('mouseover', () => {
                    document.getElementById('pqVal').innerText = score.toFixed(1);
                    document.getElementById('pqVal').style.color = status.c;
                    document.getElementById('statusLabel').innerText = status.t;
                    document.getElementById('statusLabel').style.color = status.c;
                });
            });
        }

        function flip(el) {
            el.innerText = (el.innerText === "ON") ? "OFF" : "ON";
            el.classList.toggle("off");
            updateGrid();
        }

        function doSearch() {
            const val = document.getElementById('addrSearch').value;
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${val}&countrycodes=us`)
                .then(r => r.json()).then(data => {
                    if (data.length > 0) map.setView([data[0].lat, data[0].lon], 13);
                });
        }

        map.on('moveend', updateGrid);
        updateGrid();
    </script>
</body>
</html>
